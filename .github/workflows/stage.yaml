name: Deploy Sample API on Stage

on:
  push:
    branches: [ master ]

env:
  IMAGE_URL: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-west-2.amazonaws.com/${{ secrets.AWS_ECR_REPO }}:${{ github.sha }}
  HARNESS_APP_ID: ${{ secrets.HARNESS_APP_ID }}

jobs:
  Build-and-Test:
    name: Build and Test Sample-api
    runs-on: [self-hosted, linux]
    steps:
      - name: Set up Go 1.17
        uses: actions/setup-go@v2
        with:
          go-version: 1.17
          id: Go

      - name: Checkout code into go module directory
        uses: actions/checkout@v2

      - name: Fetch dependencies
        run: |
          git config --global url."https://${{ secrets.PAT}}:x-oauth-basic@github-lvs.corpzone.internalzone.com/".insteadOf "https://github-lvs.corpzone.internalzone.com/"
          git config --global http.sslVerify false
          go get -v -t -d ./...

      - name: Test
        run: |
          export GOFR_ENV=test
          cd examples/sample-api
          mkdir build
          go test ./... -v

      - name: GolangCI-Lint
        run: |
          cd examples/sample-api
          golangci-lint run --timeout 5m0s

      - name: Build
        run: |
          cd examples/sample-api
          go build -tags musl -ldflags "-linkmode external" -o main

      - name: Upload binary to artifact
        uses: actions/upload-artifact@v2
        with:
          name: app-binary
          path: main

  Dockerize:
    runs-on: [self-hosted, linux]
    steps:
      - name: Set up Go 1.17
        uses: actions/setup-go@v2
        with:
          go-version: 1.17
          id: Go

      - name: Checkout code into go module directory
        uses: actions/checkout@v2

      - name: Download binary from artifact
        uses: actions/download-artifact@v2
        with:
          name: app-binary
          path: main

      - name: Build and Push docker image to AWS ECR
        uses: docker://ghcr.io/kciter/aws-ecr-action:latest
        with:
          access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          account_id: ${{ secrets.AWS_ACCOUNT_ID }}
          repo: ${{ secrets.AWS_ECR_REPO }}
          region: us-west-2
          dockerfile: ./Dockerfile
          path: .
          tags: ${{ github.sha }}

  Deploy-on-Stage:
    needs: Dockerize
    runs-on: [ self-hosted, linux, centos7 ]
    steps:
      - name: Trigger harness pipeline for deployment on STAGE environment
        run: |
          template='{"application":"%s","parameters":{"image":"%s"}}'
          jsonData=$( printf "$template" "$HARNESS_APP_ID" "$IMAGE_URL" )
          curl -X POST -H 'content-type: application/json' --url ${{ secrets.HARNESS_STAGE_WEBHOOK_URL }} -d $jsonData
